<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.busanbank.mapper.UserCouponMapper">

    <!-- ðŸ”¥ Flutter APIìš©: ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í° ì¡°íšŒ -->
    <select id="selectAvailableCoupons" resultType="kr.co.busanbank.dto.UserCouponDTO">
        SELECT
        UC.USERCOUPONID AS ucNo,
        UC.USERID AS userNo,
        UC.COUPONID AS couponId,
        C.COUPONNAME AS couponName,
        C.RATEINCREASE AS bonusRate,
        UC.STATUS AS status,
        UC.ISSUEDDATE AS receivedAt,
        UC.USEDDATE AS usedAt,
        C.VALIDTO AS expiryDate
        FROM USERCOUPON UC
        JOIN COUPON C ON UC.COUPONID = C.COUPONID
        LEFT JOIN PRODUCT P ON UC.PRODUCTNO = P.PRODUCTNO  <!-- âœ… USERCOUPON.PRODUCTNO! -->
        WHERE UC.USERID = #{userNo}
        AND UC.STATUS = 'UNUSED'   <!-- âœ… STATUSë¡œ ë³€ê²½! -->
        AND (P.CATEGORYID = 9 OR UC.PRODUCTNO IS NULL)   <!-- âœ… NULL í—ˆìš© -->
        ORDER BY UC.CREATEDAT DESC
    </select>

</mapper>