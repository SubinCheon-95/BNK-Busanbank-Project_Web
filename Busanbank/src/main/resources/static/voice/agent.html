<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ìƒë‹´ì‚¬ ìŒì„± ìƒë‹´ (Agora)</title>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
        .card { max-width: 680px; padding: 16px; border: 1px solid #ddd; border-radius: 12px; }
        label { display:block; margin-top: 12px; font-weight: 600; }
        input { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 10px; }
        button { margin-top: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid #333; background: #fff; cursor: pointer; }
        button:disabled { opacity: .5; cursor: not-allowed; }
        .row { display:flex; gap: 8px; flex-wrap: wrap; }
        pre { background:#f7f7f7; padding: 12px; border-radius: 10px; overflow:auto; height: 220px; }
        .ok { color: #0a7; font-weight: 700; }
        .bad { color: #c22; font-weight: 700; }
    </style>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
</head>

<body>
<h2>ìƒë‹´ì‚¬ ìŒì„± ìƒë‹´ (Web)</h2>

<div class="card">
    <label>ì„¸ì…˜ ID</label>
    <input id="sessionId" value="" />

    <div class="row">
        <button id="btnJoin">ì…ì¥(Join)</button>
        <button id="btnLeave" disabled>í†µí™” ì¢…ë£Œ(Leave)</button>
        <button id="btnMute" disabled>ë§ˆì´í¬ ë„ê¸°</button>
    </div>

    <p id="status" class="bad">ëŒ€ê¸° ì¤‘</p>
    <pre id="log"></pre>
</div>

<script>
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const statusEl = $("status");

    const CTX = "/busanbank";
    const VOICE_BASE = "/cs/call/voice";   // accept/end
    const TOKEN_API = "/cs/call/token";    // âœ… 403 ë°©ì§€: ì—¬ê¸° ê³ ì •
    const AGENT_WS_PATH = "/ws/call-agent"; // âœ… CallAgentWebSocketHandler ê²½ë¡œ

    function log(msg) {
        logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    function getSessionId() {
        const qs = new URLSearchParams(location.search);
        return (qs.get("sessionId") || $("sessionId").value || "").trim();
    }

    function getConsultantId() {
        const qs = new URLSearchParams(location.search);
        return (window.CONSULTANT_ID || qs.get("consultantId") || "").trim();
    }

    // =========================
    // Agora
    // =========================
    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localAudioTrack = null;
    let muted = false;
    let hangingUp = false;

    client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        log(`ì›ê²© ìœ ì € publish: uid=${user.uid}, type=${mediaType}`);
        if (mediaType === "audio") user.audioTrack.play();
    });

    client.on("user-unpublished", (user, mediaType) => {
        log(`ì›ê²© ìœ ì € unpublish: uid=${user.uid}, type=${mediaType}`);
    });

    // =========================
    // APIs
    // =========================
    async function acceptVoice(sessionId) {
        const res = await fetch(`${CTX}${VOICE_BASE}/${encodeURIComponent(sessionId)}/accept`, {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
        });

        const ct = res.headers.get("content-type") || "";
        const body = ct.includes("application/json")
            ? await res.json().catch(() => ({}))
            : await res.text();

        if (!res.ok) throw new Error(typeof body === "string" ? body : body?.reason || "accept failed");
        if (body && typeof body === "object" && body.ok === false) throw new Error(body.reason || "accept failed");

        log("accept ì„±ê³µ");
        return body;
    }

    async function fetchToken(sessionId) {
        const res = await fetch(`${CTX}${TOKEN_API}`, {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId, role: "CONSULTANT" }),
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(`token api failed: ${res.status} ${text}`);
        }
        return await res.json(); // { appId, channel, uid, token }
    }

    function endVoiceUrl(sessionId) {
        return `${CTX}${VOICE_BASE}/${encodeURIComponent(sessionId)}/end`;
    }

    async function endVoiceOnServer(sessionId) {
        try {
            await fetch(endVoiceUrl(sessionId), {
                method: "POST",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" },
                keepalive: true,
            });
            return true;
        } catch (e) {
            log(`end í˜¸ì¶œ ì‹¤íŒ¨(ë¬´ì‹œ): ${e.message}`);
            return false;
        }
    }

    async function leaveAgoraOnly() {
        try {
            if (localAudioTrack) {
                localAudioTrack.stop();
                localAudioTrack.close();
                localAudioTrack = null;
            }
        } catch (e) {}

        try { await client.leave(); } catch (e) {}
        muted = false;
    }

    // =========================
    // âœ… í•œ ë²ˆì— ê¹”ë” ì¢…ë£Œ
    // =========================
    async function safeHangup(reason) {
        if (hangingUp) return;
        hangingUp = true;

        const sessionId = getSessionId();

        // 1) ì„œë²„ end ë¨¼ì € (agent_busy/redis ì •ë¦¬ ëª©ì )
        if (sessionId) {
            await endVoiceOnServer(sessionId);
            log(`end í˜¸ì¶œ ì™„ë£Œ (${reason || ""})`);
        }

        // 2) agora leave
        await leaveAgoraOnly();

        // 3) UI ì •ë¦¬
        $("btnJoin").disabled = false;
        $("btnLeave").disabled = true;
        $("btnMute").disabled = true;
        $("btnMute").textContent = "ë§ˆì´í¬ ë„ê¸°";

        statusEl.textContent = "ì¢…ë£Œë¨";
        statusEl.className = "bad";

        // 4) ì°½ ë‹«ê¸° ì‹œë„(ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
        try { window.close(); } catch (e) {}
    }

    // =========================
    // âœ… ìƒë‹´ì‚¬ WS: VOICE_ENDED ìˆ˜ì‹  ì‹œ ìë™ ì¢…ë£Œ
    // =========================
    let agentWs = null;

    function connectAgentWs() {
        const consultantId = getConsultantId();
        if (!consultantId) {
            log("consultantIdê°€ ì—†ì–´ ìƒë‹´ì‚¬ WS(VOICE_ENDED ìë™ì¢…ë£Œ)ëŠ” ìŠ¤í‚µë©ë‹ˆë‹¤. (íŒì—… URLì— consultantId=15 ë¶™ì´ì„¸ìš”)");
            return;
        }

        const wsProto = (location.protocol === "https:") ? "wss://" : "ws://";
        const wsUrl = wsProto + location.host + `${CTX}${AGENT_WS_PATH}?consultantId=${encodeURIComponent(consultantId)}`;

        agentWs = new WebSocket(wsUrl);

        agentWs.onopen = () => log("ğŸ“¡ CallAgent WS connected");
        agentWs.onmessage = async (evt) => {
            try {
                const msg = JSON.parse(evt.data);
                if (msg.type === "VOICE_ENDED") {
                    const sid = getSessionId();
                    const endedSid = msg.voiceSessionId || msg.sessionId;
                    if (sid && endedSid === sid) {
                        log("ğŸ“£ VOICE_ENDED ìˆ˜ì‹  â†’ ìë™ ì¢…ë£Œ");
                        await safeHangup("REMOTE_ENDED");
                    }
                }
            } catch (e) {}
        };

        agentWs.onclose = () => setTimeout(connectAgentWs, 1500);
        agentWs.onerror = () => {};
    }

    connectAgentWs();

    // =========================
    // Join
    // =========================
    $("btnJoin").onclick = async () => {
        try {
            hangingUp = false; // âœ… ë‹¤ìŒ í†µí™” ëŒ€ë¹„ ë¦¬ì…‹

            const sessionId = getSessionId();
            if (!sessionId) return alert("sessionIdê°€ ì—†ìŠµë‹ˆë‹¤.");

            statusEl.textContent = "ìˆ˜ë½ ì²˜ë¦¬ ì¤‘...";
            statusEl.className = "";

            await acceptVoice(sessionId);

            statusEl.textContent = "í† í° ìš”ì²­ ì¤‘...";
            const { appId, channel, uid, token } = await fetchToken(sessionId);
            log(`í† í° ìˆ˜ì‹ : channel=${channel}, uid=${uid}`);

            statusEl.textContent = "Agora ì…ì¥ ì¤‘...";
            await client.join(appId, channel, token, uid);

            localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await client.publish([localAudioTrack]);

            $("btnJoin").disabled = true;
            $("btnLeave").disabled = false;
            $("btnMute").disabled = false;
            $("btnMute").textContent = "ë§ˆì´í¬ ë„ê¸°";

            statusEl.textContent = "í†µí™” ì§„í–‰ ì¤‘";
            statusEl.className = "ok";
            log("ì…ì¥ ì™„ë£Œ + ë§ˆì´í¬ publish ì™„ë£Œ");
        } catch (e) {
            statusEl.textContent = "ì‹¤íŒ¨";
            statusEl.className = "bad";
            log(`ERROR: ${e.message}`);
            console.error(e);
        }
    };

    $("btnMute").onclick = async () => {
        if (!localAudioTrack) return;
        muted = !muted;
        await localAudioTrack.setEnabled(!muted);
        $("btnMute").textContent = muted ? "ë§ˆì´í¬ ì¼œê¸°" : "ë§ˆì´í¬ ë„ê¸°";
        log(muted ? "ë§ˆì´í¬ OFF" : "ë§ˆì´í¬ ON");
    };

    // âœ… Leave = í†µí™” ì¢…ë£Œ (ì„œë²„ end + agora leave)
    $("btnLeave").onclick = async () => {
        await safeHangup("AGENT_LEAVE");
    };

    // âœ… íƒ­ ë‹«í˜/ìƒˆë¡œê³ ì¹¨ì—ë„ end ë³´ë‚´ì„œ agent_busy ë°©ì§€
    window.addEventListener("beforeunload", () => {
        const sessionId = getSessionId();
        if (!sessionId) return;

        const url = endVoiceUrl(sessionId);
        try {
            const blob = new Blob([], { type: "application/json" });
            navigator.sendBeacon(url, blob);
        } catch (e) {}

        try {
            fetch(url, { method: "POST", credentials: "same-origin", keepalive: true });
        } catch (e) {}
    });
</script>

</body>
</html>
