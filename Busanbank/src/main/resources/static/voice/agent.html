<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>ìƒë‹´ì‚¬ ìŒì„± ìƒë‹´</title>

    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>

    <style>
        :root{
            --bg: #f6f7fb;
            --card: #ffffff;
            --line: #e6e8ef;
            --text: #111827;
            --muted: #6b7280;

            --ok: #16a34a;
            --warn: #f59e0b;
            --bad: #dc2626;

            --btn: #111827;
            --btnText: #ffffff;
            --btnSub: #ffffff;
            --btnSubText: #111827;

            --radius: 18px;
            --shadow: 0 10px 30px rgba(17,24,39,.10);
            --shadow2: 0 6px 18px rgba(17,24,39,.08);
        }

        *{ box-sizing:border-box; }
        html, body { height:100%; }
        body{
            margin:0;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
            background: radial-gradient(1000px 500px at 15% 0%, rgba(59,130,246,.12), transparent 60%),
            radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
            var(--bg);
            color: var(--text);
            padding: 26px;
            font-size: 15px;
        }

        .wrap{
            max-width: 1200px;
            margin: 0 auto;
            display:flex;
            flex-direction:column;
            gap: 14px;
        }

        .topbar{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .brand{
            display:flex;
            align-items:center;
            gap: 12px;
            min-width: 0;
        }

        .logo{
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: linear-gradient(135deg, #22c55e, #3b82f6);
            box-shadow: var(--shadow2);
            flex: 0 0 auto;
        }

        .brand h1{
            margin:0;
            font-size: 28px;
            letter-spacing: .2px;
            font-weight: 800;
            line-height: 1.15;
        }

        .brand .sub{
            font-size: 16px;
            color: var(--muted);
            margin-top: 3px;
        }

        .right-actions{
            display:flex;
            align-items:center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content:flex-end;
        }

        .chip{
            display:inline-flex;
            align-items:center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid var(--line);
            box-shadow: var(--shadow2);
            font-size: 18px;
            color: var(--text);
            font-weight: 700;
        }
        .dot{
            width: 10px; height: 10px; border-radius: 999px;
            background: #d1d5db;
        }
        .chip.ok .dot{ background: var(--ok); }
        .chip.warn .dot{ background: var(--warn); }
        .chip.bad .dot{ background: var(--bad); }

        .btn{
            appearance:none;
            border: 1px solid var(--line);
            background: var(--btnSub);
            color: var(--btnSubText);
            padding: 12px 14px;
            border-radius: 14px;
            cursor:pointer;
            font-weight: 800;
            font-size: 18px;
            display:inline-flex;
            align-items:center;
            gap: 10px;
            transition: transform .05s ease, background .15s ease, border-color .15s ease;
            user-select:none;
            box-shadow: var(--shadow2);
        }
        .btn:hover{ transform: translateY(-1px); }
        .btn:active{ transform: translateY(0px); }
        .btn:disabled{
            opacity: .55;
            cursor: not-allowed;
            transform:none;
        }

        .btn.primary{
            border-color: #111827;
            background: var(--btn);
            color: var(--btnText);
        }
        .btn.danger{
            border-color: rgba(220,38,38,.35);
            background: rgba(220,38,38,.10);
            color: #991b1b;
        }

        .panel{
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow:hidden;
        }

        .panel-header{
            padding: 16px 18px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
            border-bottom: 1px solid var(--line);
            background: #ffffff;
        }

        .panel-header .title{
            display:flex;
            flex-direction:column;
            gap: 6px;
            min-width: 0;
        }

        .panel-header .title b{
            font-size: 20px;
            letter-spacing: .2px;
            font-weight: 900;
        }
        .panel-header .title span{
            font-size: 15px;
            color: var(--muted);
            line-height: 1.35;
        }

        .panel-body{
            padding: 18px;
            display:grid;
            grid-template-columns: 1fr 360px;
            gap: 16px;
        }

        @media (max-width: 920px){
            .panel-body{ grid-template-columns: 1fr; }
        }

        .info-card{
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow2);
            display:flex;
            flex-direction:column;
            gap: 12px;
        }

        .field{
            display:flex;
            flex-direction:column;
            gap: 8px;
        }
        .label{
            font-size: 16px;
            color: var(--muted);
            font-weight: 700;
        }
        .value{
            font-size: 20px;
            font-weight: 900;
            letter-spacing: .2px;
            word-break: break-all;
            color: #0f172a;
        }

        .session-input{
            width: 100%;
            padding: 14px 14px;
            border-radius: 14px;
            border: 1px solid var(--line);
            background: #fff;
            color: var(--text);
            outline: none;
            font-size: 18px;
            font-weight: 700;
        }
        .session-input:focus{
            border-color: rgba(59,130,246,.65);
            box-shadow: 0 0 0 6px rgba(59,130,246,.14);
        }

        .helper{
            font-size: 16px;
            color: var(--muted);
            line-height: 1.45;
        }

        .controls{
            display:flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .mute-badge{
            display:inline-flex;
            align-items:center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px dashed rgba(17,24,39,.25);
            color: #111827;
            background: rgba(17,24,39,.03);
            font-size: 18px;
            font-weight: 800;
            justify-content:center;
            white-space: nowrap;
        }

        /* Debug */
        .debug{
            border-top: 1px solid var(--line);
            background: #fbfbfd;
        }
        .debug-head{
            padding: 12px 18px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
            cursor: pointer;
            user-select:none;
        }
        .debug-head span{
            font-size: 16px;
            color: var(--muted);
            font-weight: 800;
            display:flex;
            align-items:center;
            gap: 10px;
        }
        .caret{
            width: 9px; height: 9px;
            border-right: 2px solid rgba(17,24,39,.55);
            border-bottom: 2px solid rgba(17,24,39,.55);
            transform: rotate(-45deg);
            transition: transform .15s ease;
        }
        .debug.open .caret{ transform: rotate(45deg); }

        pre{
            margin:0;
            padding: 12px 18px 16px;
            max-height: 240px;
            overflow:auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 15px;
            color: #0f172a;
            display:none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            background: #ffffff;
            border-top: 1px solid var(--line);
        }
        .debug.open pre{ display:block; }

        /* small icons */
        .ico{
            width: 22px; height: 22px; display:inline-block;
            border-radius: 6px;
            background: rgba(17,24,39,.08);
            position: relative;
            flex: 0 0 auto;
        }
        .ico.phone::before{
            content:"";
            position:absolute;
            inset: 4px 5px;
            border: 2px solid rgba(17,24,39,.75);
            border-top: none;
            border-left: none;
            transform: rotate(-35deg);
            border-radius: 3px;
        }
        .ico.mic::before{
            content:"";
            position:absolute;
            left: 7px; top: 3px;
            width: 4px; height: 9px;
            border-radius: 3px;
            background: rgba(17,24,39,.78);
        }
        .ico.mic::after{
            content:"";
            position:absolute;
            left: 6px; bottom: 3px;
            width: 6px; height: 2px;
            border-radius: 2px;
            background: rgba(17,24,39,.72);
            box-shadow: 0 -3px 0 0 rgba(17,24,39,.38);
        }
        .ico.stop::before{
            content:"";
            position:absolute;
            inset: 4px;
            background: rgba(17,24,39,.78);
            border-radius: 3px;
        }
        .ico.bug::before{
            content:"";
            position:absolute;
            left: 4px; top: 4px;
            width: 10px; height: 10px;
            border: 2px solid rgba(17,24,39,.65);
            border-radius: 50%;
        }
    </style>
</head>

<body>
<div class="wrap">
    <div class="topbar">
        <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
                <h1>ìƒë‹´ì‚¬ ìŒì„± ìƒë‹´</h1>
                <div class="sub">ì‹¤ì‹œê°„ ìŒì„± ì—°ê²° (Agora)</div>
            </div>
        </div>

        <div class="right-actions">
            <div id="statusChip" class="chip warn" title="ì—°ê²° ìƒíƒœ">
                <span class="dot"></span>
                <span id="statusText">ëŒ€ê¸° ì¤‘</span>
            </div>

            <button id="btnToggleDebug" class="btn" type="button" title="ë””ë²„ê·¸ íŒ¨ë„ ì—´ê¸°/ë‹«ê¸°">
                <span class="ico bug" aria-hidden="true"></span>
                ë””ë²„ê·¸
            </button>
        </div>
    </div>

    <section class="panel">
        <div class="panel-header">
            <div class="title">
                <b id="panelTitle">í†µí™” ì¤€ë¹„</b>
                <span id="panelDesc">ì„¸ì…˜ í™•ì¸ í›„ ì…ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ í†µí™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</span>
            </div>
            <div class="mute-badge" id="muteBadge" style="display:none;">
                <span class="ico mic" aria-hidden="true"></span>
                ë§ˆì´í¬ êº¼ì§
            </div>
        </div>

        <div class="panel-body">
            <!-- Left -->
            <div class="info-card">
                <div class="field">
                    <div class="label">ì„¸ì…˜ ID</div>
                    <input id="sessionId" class="session-input" value="" placeholder="ì˜ˆ) VOICE-20260106-813779" />
                    <div class="helper">

                    </div>
                </div>

                <div class="controls">
                    <button id="btnJoin" class="btn primary" type="button">
                        <span class="ico phone" aria-hidden="true"></span>
                        ì…ì¥(Join)
                    </button>
                    <button id="btnLeave" class="btn danger" type="button" disabled>
                        <span class="ico stop" aria-hidden="true"></span>
                        í†µí™” ì¢…ë£Œ(Leave)
                    </button>
                    <button id="btnMute" class="btn" type="button" disabled>
                        <span class="ico mic" aria-hidden="true"></span>
                        ë§ˆì´í¬ ë„ê¸°
                    </button>
                </div>

                <div class="helper" id="helperHint">
                    í†µí™” ì¤‘ì—ëŠ” ìƒëŒ€ë°© ì˜¤ë””ì˜¤ê°€ ìë™ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤. ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ì´ ëœ¨ë©´ â€œí—ˆìš©â€ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
                </div>
            </div>

            <!-- Right -->
            <div class="info-card">
                <div class="field">
                    <div class="label">ìƒíƒœ</div>
                    <div class="value" id="statusBig">ëŒ€ê¸° ì¤‘</div>
                </div>

                <div class="field">
                    <div class="label">ì•ˆë‚´</div>
                    <div class="helper">
                        â€¢ ì…ì¥ í›„ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ì´ ëœ¨ë©´ â€œí—ˆìš©â€ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.<br/>
                        â€¢ ë§ˆì´í¬ ì¥ì¹˜ê°€ ì—†ê±°ë‚˜ ê¶Œí•œì´ ê±°ë¶€ë˜ë©´ í†µí™”ê°€ ì‹œì‘ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <div class="field">
                    <div class="label">ë””ë²„ê·¸</div>
                    <div class="helper">
                        PPT ìº¡ì²˜ ì‹œì—ëŠ” ë‹«ì•„ë‘ì„¸ìš”. ë¬¸ì œê°€ ìˆì„ ë•Œë§Œ ë””ë²„ê·¸ë¥¼ ì—´ì–´ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>

        <div class="debug" id="debugPanel">
            <div class="debug-head" id="debugHead">
                <span><span class="caret" aria-hidden="true"></span>ì‹¤ì‹œê°„ ë¡œê·¸</span>
                <span>í† ê¸€</span>
            </div>
            <pre id="log"></pre>
        </div>
    </section>
</div>

<script>
    const $ = (id) => document.getElementById(id);

    const logEl = $("log");
    const statusTextEl = $("statusText");
    const statusChipEl = $("statusChip");
    const statusBigEl = $("statusBig");
    const panelTitleEl = $("panelTitle");
    const panelDescEl = $("panelDesc");
    const muteBadgeEl = $("muteBadge");

    const btnJoin = $("btnJoin");
    const btnLeave = $("btnLeave");
    const btnMute = $("btnMute");

    const btnToggleDebug = $("btnToggleDebug");
    const debugPanel = $("debugPanel");
    const debugHead = $("debugHead");

    // ====== í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì • ======
    const CTX = "/busanbank";
    const VOICE_BASE = "/cs/call/voice";
    const TOKEN_API = "/cs/call/token";
    const AGENT_WS_PATH = "/ws/call-agent";

    function setStatus(mode, text, title, desc) {
        statusChipEl.classList.remove("ok","warn","bad");
        statusChipEl.classList.add(mode);

        statusTextEl.textContent = text;
        statusBigEl.textContent = text;

        if (title) panelTitleEl.textContent = title;
        if (desc) panelDescEl.textContent = desc;
    }

    function log(msg) {
        logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    function getSessionId() {
        const qs = new URLSearchParams(location.search);
        return (qs.get("sessionId") || $("sessionId").value || "").trim();
    }

    function getConsultantId() {
        const qs = new URLSearchParams(location.search);
        return (window.CONSULTANT_ID || qs.get("consultantId") || "").trim();
    }

    // Debug í† ê¸€
    function toggleDebug() { debugPanel.classList.toggle("open"); }
    btnToggleDebug.addEventListener("click", toggleDebug);
    debugHead.addEventListener("click", toggleDebug);

    // sessionId ì´ˆê¸° ì£¼ì…
    (function initSession() {
        const sid = getSessionId();
        if (sid) $("sessionId").value = sid;
    })();

    // =========================
    // Agora
    // =========================
    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    let localAudioTrack = null;
    let muted = false;
    let hangingUp = false;

    client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        log(`ì›ê²© ìœ ì € publish: uid=${user.uid}, type=${mediaType}`);
        if (mediaType === "audio") user.audioTrack.play();
    });

    client.on("user-unpublished", (user, mediaType) => {
        log(`ì›ê²© ìœ ì € unpublish: uid=${user.uid}, type=${mediaType}`);
    });

    // =========================
    // APIs
    // =========================
    async function acceptVoice(sessionId) {
        const res = await fetch(`${CTX}${VOICE_BASE}/${encodeURIComponent(sessionId)}/accept`, {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
        });

        const ct = res.headers.get("content-type") || "";
        const body = ct.includes("application/json")
            ? await res.json().catch(() => ({}))
            : await res.text();

        if (!res.ok) throw new Error(typeof body === "string" ? body : body?.reason || "accept failed");
        if (body && typeof body === "object" && body.ok === false) throw new Error(body.reason || "accept failed");

        log("accept ì„±ê³µ");
        return body;
    }

    async function fetchToken(sessionId) {
        const res = await fetch(`${CTX}${TOKEN_API}`, {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId, role: "CONSULTANT" }),
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(`token api failed: ${res.status} ${text}`);
        }
        return await res.json();
    }

    function endVoiceUrl(sessionId) {
        return `${CTX}${VOICE_BASE}/${encodeURIComponent(sessionId)}/end`;
    }

    async function endVoiceOnServer(sessionId) {
        try {
            await fetch(endVoiceUrl(sessionId), {
                method: "POST",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" },
                keepalive: true,
            });
            return true;
        } catch (e) {
            log(`end í˜¸ì¶œ ì‹¤íŒ¨(ë¬´ì‹œ): ${e.message}`);
            return false;
        }
    }

    async function leaveAgoraOnly() {
        try {
            if (localAudioTrack) {
                localAudioTrack.stop();
                localAudioTrack.close();
                localAudioTrack = null;
            }
        } catch (e) {}

        try { await client.leave(); } catch (e) {}
        muted = false;
        muteBadgeEl.style.display = "none";
    }

    async function safeHangup(reason) {
        if (hangingUp) return;
        hangingUp = true;

        const sessionId = getSessionId();

        if (sessionId) {
            await endVoiceOnServer(sessionId);
            log(`end í˜¸ì¶œ ì™„ë£Œ (${reason || ""})`);
        }

        await leaveAgoraOnly();

        btnJoin.disabled = false;
        btnLeave.disabled = true;
        btnMute.disabled = true;
        btnMute.textContent = "ë§ˆì´í¬ ë„ê¸°";

        setStatus("warn", "ì¢…ë£Œë¨", "í†µí™” ì¢…ë£Œ", "ì°½ì´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.");
        try { window.close(); } catch (e) {}
    }

    // ìƒë‹´ì‚¬ WS: VOICE_ENDED ìˆ˜ì‹  ì‹œ ìë™ ì¢…ë£Œ
    let agentWs = null;

    function connectAgentWs() {
        const consultantId = getConsultantId();
        if (!consultantId || consultantId.includes("[[")) {
            log("consultantIdê°€ ì—†ì–´ ìƒë‹´ì‚¬ WS(VOICE_ENDED ìë™ì¢…ë£Œ)ëŠ” ìŠ¤í‚µë©ë‹ˆë‹¤. (ì¿¼ë¦¬ consultantId í™•ì¸)");
            return;
        }

        const wsProto = (location.protocol === "https:") ? "wss://" : "ws://";
        const wsUrl = wsProto + location.host + `${CTX}${AGENT_WS_PATH}?consultantId=${encodeURIComponent(consultantId)}`;

        agentWs = new WebSocket(wsUrl);

        agentWs.onopen = () => log(`ğŸ“¡ CallAgent WS connected (consultantId=${consultantId})`);
        agentWs.onmessage = async (evt) => {
            try {
                const msg = JSON.parse(evt.data);
                if (msg.type === "VOICE_ENDED") {
                    const sid = getSessionId();
                    const endedSid = msg.voiceSessionId || msg.sessionId;
                    if (sid && endedSid === sid) {
                        log("ğŸ“£ VOICE_ENDED ìˆ˜ì‹  â†’ ìë™ ì¢…ë£Œ");
                        await safeHangup("REMOTE_ENDED");
                    }
                }
            } catch (e) {}
        };

        agentWs.onclose = () => setTimeout(connectAgentWs, 1500);
        agentWs.onerror = () => {};
    }

    connectAgentWs();

    // Join
    btnJoin.onclick = async () => {
        try {
            hangingUp = false;

            const sessionId = getSessionId();
            if (!sessionId) return alert("sessionIdê°€ ì—†ìŠµë‹ˆë‹¤.");

            setStatus("warn", "ìˆ˜ë½ ì²˜ë¦¬ ì¤‘...", "í†µí™” ì¤€ë¹„", "ì„¸ì…˜ì„ ìˆ˜ë½í•˜ê³  ì—°ê²°ì„ ì¤€ë¹„í•©ë‹ˆë‹¤.");
            await acceptVoice(sessionId);

            setStatus("warn", "í† í° ìš”ì²­ ì¤‘...", "í† í° ë°œê¸‰", "ë³´ì•ˆ í† í°ì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤.");
            const { appId, channel, uid, token } = await fetchToken(sessionId);
            log(`í† í° ìˆ˜ì‹ : channel=${channel}, uid=${uid}`);

            setStatus("warn", "Agora ì…ì¥ ì¤‘...", "Agora ì…ì¥", "ì˜¤ë””ì˜¤ ì¥ì¹˜ í™•ì¸ í›„ ì±„ë„ì— ì…ì¥í•©ë‹ˆë‹¤.");
            await client.join(appId, channel, token, uid);

            localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await client.publish([localAudioTrack]);

            btnJoin.disabled = true;
            btnLeave.disabled = false;
            btnMute.disabled = false;
            btnMute.textContent = "ë§ˆì´í¬ ë„ê¸°";

            setStatus("ok", "í†µí™” ì§„í–‰ ì¤‘", "í†µí™” ì§„í–‰", "ìƒëŒ€ë°©ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            log("ì…ì¥ ì™„ë£Œ + ë§ˆì´í¬ publish ì™„ë£Œ");
        } catch (e) {
            setStatus("bad", "ì‹¤íŒ¨", "ì—°ê²° ì‹¤íŒ¨", "ë§ˆì´í¬ ì¥ì¹˜/ê¶Œí•œ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            log(`ERROR: ${e.message}`);
            console.error(e);
        }
    };

    btnMute.onclick = async () => {
        if (!localAudioTrack) return;
        muted = !muted;
        await localAudioTrack.setEnabled(!muted);
        btnMute.textContent = muted ? "ë§ˆì´í¬ ì¼œê¸°" : "ë§ˆì´í¬ ë„ê¸°";
        muteBadgeEl.style.display = muted ? "inline-flex" : "none";
        log(muted ? "ë§ˆì´í¬ OFF" : "ë§ˆì´í¬ ON");
    };

    btnLeave.onclick = async () => {
        await safeHangup("AGENT_LEAVE");
    };

    window.addEventListener("beforeunload", () => {
        const sessionId = getSessionId();
        if (!sessionId) return;

        const url = endVoiceUrl(sessionId);

        try {
            const blob = new Blob([], { type: "application/json" });
            navigator.sendBeacon(url, blob);
        } catch (e) {}

        try {
            fetch(url, { method: "POST", credentials: "same-origin", keepalive: true });
        } catch (e) {}
    });
</script>
</body>
</html>
