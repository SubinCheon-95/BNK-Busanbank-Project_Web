<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>상담사 음성 상담 (Agora)</title>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
        .card { max-width: 560px; padding: 16px; border: 1px solid #ddd; border-radius: 12px; }
        label { display:block; margin-top: 12px; font-weight: 600; }
        input { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 10px; }
        button { margin-top: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid #333; background: #fff; cursor: pointer; }
        button:disabled { opacity: .5; cursor: not-allowed; }
        .row { display:flex; gap: 8px; flex-wrap: wrap; }
        pre { background:#f7f7f7; padding: 12px; border-radius: 10px; overflow:auto; }
        .ok { color: #0a7; font-weight: 700; }
        .bad { color: #c22; font-weight: 700; }
    </style>

    <!-- Agora Web SDK (CDN) -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>

</head>

<body>
<h2>상담사 음성 상담 (Web)</h2>

<div class="card">
    <label>세션 ID</label>
    <input id="sessionId" value="S123" />

    <div class="row">
        <button id="btnJoin">입장(Join)</button>
        <button id="btnLeave" disabled>나가기(Leave)</button>
        <button id="btnMute" disabled>마이크 끄기</button>
    </div>

    <p id="status" class="bad">대기 중</p>
    <pre id="log"></pre>
</div>

<script>
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const statusEl = $("status");

    const CTX = "/busanbank";
    const VOICE_BASE = "/cs/call/voice";

    function log(msg) {
        logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    function getSessionId() {
        const qs = new URLSearchParams(location.search);
        return qs.get("sessionId") || $("sessionId").value.trim();
    }

    const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    let localAudioTrack = null;
    let joined = false;
    let muted = false;

    client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        log(`원격 유저 publish: uid=${user.uid}, type=${mediaType}`);
        if (mediaType === "audio") user.audioTrack.play();
    });

    client.on("user-unpublished", (user, mediaType) => {
        log(`원격 유저 unpublish: uid=${user.uid}, type=${mediaType}`);
    });

    // =========================
    // 1️⃣ 상담사 accept API
    // =========================
    async function acceptVoice(sessionId) {
        const res = await fetch(
            `${CTX}${VOICE_BASE}/${encodeURIComponent(sessionId)}/accept`,
            {
                method: "POST",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" }
            }
        );

        const ct = res.headers.get("content-type") || "";
        const body = ct.includes("application/json")
            ? await res.json().catch(() => ({}))
            : await res.text();

        if (!res.ok) {
            throw new Error(
                typeof body === "string"
                    ? body
                    : body?.reason || "accept failed"
            );
        }

        if (body && typeof body === "object" && body.ok === false) {
            throw new Error(body.reason || "accept failed");
        }

        log("accept 성공");
        return body;
    }

    // =========================
    // 2️⃣ 상담사 토큰 API
    // =========================
    async function fetchToken(sessionId) {
        const res = await fetch(`${CTX}/cs/call/token`, {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                sessionId: sessionId,
                role: "CONSULTANT"
            })
        });

        if (!res.ok) {
            const text = await res.text();
            throw new Error(`token api failed: ${res.status} ${text}`);
        }

        return await res.json(); // { appId, channel, uid, token }
    }

    // =========================
    // 3️⃣ Join 버튼
    // =========================
    $("btnJoin").onclick = async () => {
        try {
            const sessionId = getSessionId();
            if (!sessionId) return alert("sessionId가 없습니다.");

            statusEl.textContent = "수락 처리 중...";
            statusEl.className = "";

            // ✅ (1) accept 먼저
            await acceptVoice(sessionId);

            statusEl.textContent = "토큰 요청 중...";
            const { appId, channel, uid, token } = await fetchToken(sessionId);
            log(`토큰 수신: channel=${channel}, uid=${uid}`);

            statusEl.textContent = "Agora 입장 중...";
            await client.join(appId, channel, token, uid);

            localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            await client.publish([localAudioTrack]);

            joined = true;
            muted = false;

            $("btnJoin").disabled = true;
            $("btnLeave").disabled = false;
            $("btnMute").disabled = false;
            $("btnMute").textContent = "마이크 끄기";

            statusEl.textContent = "통화 진행 중";
            statusEl.className = "ok";
            log("입장 완료 + 마이크 publish 완료");
        } catch (e) {
            statusEl.textContent = "실패";
            statusEl.className = "bad";
            log(`ERROR: ${e.message}`);
            console.error(e);
        }
    };

    // =========================
    // 4️⃣ Mute
    // =========================
    $("btnMute").onclick = async () => {
        if (!localAudioTrack) return;
        muted = !muted;
        await localAudioTrack.setEnabled(!muted);
        $("btnMute").textContent = muted ? "마이크 켜기" : "마이크 끄기";
        log(muted ? "마이크 OFF" : "마이크 ON");
    };

    // =========================
    // 5️⃣ Leave (종료는 콘솔에서 처리)
    // =========================
    $("btnLeave").onclick = async () => {
        try {
            if (localAudioTrack) {
                localAudioTrack.stop();
                localAudioTrack.close();
                localAudioTrack = null;
            }
            await client.leave();
            joined = false;

            $("btnJoin").disabled = false;
            $("btnLeave").disabled = true;
            $("btnMute").disabled = true;

            statusEl.textContent = "나가기 완료";
            statusEl.className = "bad";
            log("leave 완료");
        } catch (e) {
            log(`ERROR: ${e.message}`);
            console.error(e);
        }
    };
</script>

</body>
</html>
